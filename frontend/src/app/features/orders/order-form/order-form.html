<div class="order-form-container">
  <div class="header">
    <button class="btn-back" (click)="goBack()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
      Back to Orders
    </button>
    <h1>Create New Order</h1>
  </div>

  <form [formGroup]="orderForm" (ngSubmit)="onSubmit()">
    <div class="form-grid">
      <!-- Customer Selection -->
      <div class="card">
        <h2>Customer Information</h2>
        <div class="form-group">
          <label for="customerId">Select Customer *</label>
          <select
            id="customerId"
            formControlName="customerId"
            [class.error]="
              orderForm.get('customerId')?.invalid && orderForm.get('customerId')?.touched
            "
          >
            <option value="">-- Select a Customer --</option>
            @for (customer of customers(); track customer.id) {
              <option [value]="customer.id">
                {{ customer.firstName }} {{ customer.lastName }} ({{ customer.email }})
              </option>
            }
          </select>
          @if (orderForm.get('customerId')?.invalid && orderForm.get('customerId')?.touched) {
            <span class="error-message">Customer is required</span>
          }
        </div>
      </div>

      <!-- Order Items -->
      <div class="card">
        <div class="items-header">
          <h2>Order Items</h2>
          <button type="button" class="btn-add-item" (click)="addItem()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Item
          </button>
        </div>

        <div formArrayName="items">
          @for (item of items.controls; track $index; let i = $index) {
            <div [formGroupName]="i" class="item-row">
              <div class="form-group flex-grow">
                <label [for]="'product-' + i">Product *</label>
                <select
                  [id]="'product-' + i"
                  formControlName="productId"
                  (change)="onProductChange(i)"
                  [class.error]="item.get('productId')?.invalid && item.get('productId')?.touched"
                >
                  <option value="">-- Select a Product --</option>
                  @for (product of products(); track product.id) {
                    <option [value]="product.id">
                      {{ product.name }} - \${{ product.price | number: '1.2-2' }} (Stock:
                      {{ product.stockQuantity }})
                    </option>
                  }
                </select>
                @if (item.get('productId')?.invalid && item.get('productId')?.touched) {
                  <span class="error-message">Product is required</span>
                }
              </div>

              <div class="form-group">
                <label [for]="'quantity-' + i">Quantity *</label>
                <input
                  [id]="'quantity-' + i"
                  type="number"
                  formControlName="quantity"
                  min="1"
                  (change)="updateTotal()"
                  [class.error]="item.get('quantity')?.invalid && item.get('quantity')?.touched"
                />
                @if (item.get('quantity')?.invalid && item.get('quantity')?.touched) {
                  <span class="error-message">Quantity must be at least 1</span>
                }
              </div>

              <div class="item-total">
                <span class="label">Subtotal:</span>
                <span class="value">${{ getItemSubtotal(i) | number: '1.2-2' }}</span>
              </div>

              <button
                type="button"
                class="btn-remove"
                (click)="removeItem(i)"
                [disabled]="items.length === 1"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          } @empty {
            <div class="empty-items">No items added yet. Click "Add Item" to start.</div>
          }
        </div>

        <div class="order-total">
          <span class="label">Order Total:</span>
          <span class="value">${{ totalAmount() | number: '1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="goBack()">Cancel</button>
      <button type="submit" class="btn-primary" [disabled]="orderForm.invalid || submitting()">
        @if (submitting()) {
          Creating...
        } @else {
          Create Order
        }
      </button>
    </div>

    @if (error()) {
      <div class="error-banner">{{ error() }}</div>
    }
  </form>
</div>
