name: Cache Cleanup

on:
  pull_request:
    branches: [ main ]
  workflow_run:
    workflows:
      - "API Gateway CI"
      - "Customer Service CI"
      - "Order Service CI"
      - "Payment Service CI"
      - "Product Service CI"
      - "Report Service CI"
      - "User Service CI"
      - "Frontend CI"
    types:
      - completed
  workflow_dispatch:

jobs:
  cleanup:
    name: Cleanup Old Caches
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup old caches
        run: |
          echo "Fetching caches..."
          
          # Get repository info
          REPO="${{ github.repository }}"
          
          # Get all caches using GitHub CLI
          echo "Listing all caches..."
          cache_list=$(gh cache list --limit 100 --json id,key,createdAt,sizeInBytes --repo "$REPO")
          
          # Count total caches
          total_caches=$(echo "$cache_list" | jq '. | length')
          echo "Total caches found: $total_caches"
          
          # Calculate how many to delete (keep only 10 most recent)
          keep_count=10
          delete_count=$((total_caches - keep_count))
          
          if [ $delete_count -le 0 ]; then
            echo "No caches to delete. Current cache count ($total_caches) is within limit ($keep_count)."
            exit 0
          fi
          
          echo "Will delete $delete_count old caches to keep only $keep_count most recent..."
          echo ""
          
          # Get caches to delete (oldest first) and save to temp file
          echo "$cache_list" | jq -r --arg count "$delete_count" 'sort_by(.createdAt) | .[:($count | tonumber)] | .[] | "\(.id)|\(.key)|\(.createdAt)"' > caches_to_delete.txt
          
          # Delete old caches
          deleted=0
          failed=0
          
          while IFS='|' read -r cache_id cache_key created_at; do
            echo "Deleting cache: $cache_key"
            echo "  ID: $cache_id"
            echo "  Created: $created_at"
            
            # Use cache key for deletion (more reliable than ID)
            if gh cache delete "$cache_key" --repo "$REPO" 2>&1; then
              echo "✓ Successfully deleted"
              deleted=$((deleted + 1))
            else
              echo "✗ Failed to delete (trying with ID...)"
              # Fallback to ID if key doesn't work
              if gh cache delete "$cache_id" --repo "$REPO" 2>&1; then
                echo "✓ Successfully deleted using ID"
                deleted=$((deleted + 1))
              else
                echo "✗ Failed with both key and ID"
                failed=$((failed + 1))
              fi
            fi
            echo ""
          done < caches_to_delete.txt
          
          # Clean up temp file
          rm -f caches_to_delete.txt
          
          echo "================================================"
          echo "Cleanup completed."
          echo "Successfully deleted: $deleted caches"
          echo "Failed to delete: $failed caches"
          echo "Total attempted: $delete_count caches"
          echo "================================================"
          
          # Exit successfully even if some deletions failed
          exit 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
