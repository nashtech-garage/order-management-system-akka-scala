name: Cache Cleanup

on:
  workflow_run:
    workflows:
      - "API Gateway CI"
      - "Customer Service CI"
      - "Order Service CI"
      - "Payment Service CI"
      - "Product Service CI"
      - "Report Service CI"
      - "User Service CI"
      - "Frontend CI"
    types:
      - completed
  workflow_dispatch:

jobs:
  cleanup:
    name: Cleanup Old Caches
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup old caches
        run: |
          echo "Fetching caches..."
          
          # Get all caches sorted by created_at (oldest first)
          gh extension install actions/gh-actions-cache || true
          
          # Get cache list
          caches=$(gh actions-cache list --limit 100 --json id,key,createdAt --sort created_at | jq -r '.[] | "\(.id)|\(.key)|\(.createdAt)"')
          
          # Count total caches
          total_caches=$(echo "$caches" | wc -l)
          echo "Total caches found: $total_caches"
          
          # Calculate how many to delete (keep only 20 most recent)
          keep_count=20
          delete_count=$((total_caches - keep_count))
          
          if [ $delete_count -le 0 ]; then
            echo "No caches to delete. Current cache count ($total_caches) is within limit ($keep_count)."
            exit 0
          fi
          
          echo "Will delete $delete_count old caches to keep only $keep_count most recent..."
          
          # Delete old caches (oldest first)
          deleted=0
          while IFS='|' read -r cache_id cache_key created_at; do
            if [ $deleted -ge $delete_count ]; then
              break
            fi
            
            echo "Deleting cache: $cache_key (created: $created_at)"
            gh actions-cache delete "$cache_id" --confirm || echo "Failed to delete cache $cache_id"
            ((deleted++))
          done <<< "$caches"
          
          echo "Cleanup completed. Deleted $deleted caches."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
